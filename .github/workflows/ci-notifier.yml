name: CI Notifier

on:
  workflow_run:
    workflows: ["Test Workflow"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Send notification to CI Notifier
        run: |
          curl -X POST ${{ secrets.CI_NOTIFIER_WEBHOOK_URL }}/ci/webhook \
            -H "Content-Type: application/json" \
            -d '{
              "action": "completed",
              "workflow_run": {
                "id": ${{ github.event.workflow_run.id }},
                "name": "${{ github.event.workflow_run.name }}",
                "head_branch": "${{ github.event.workflow_run.head_branch }}",
                "head_sha": "${{ github.event.workflow_run.head_sha }}",
                "status": "${{ github.event.workflow_run.status }}",
                "conclusion": "${{ github.event.workflow_run.conclusion }}",
                "html_url": "${{ github.event.workflow_run.html_url }}",
                "run_number": ${{ github.event.workflow_run.run_number }},
                "event": "${{ github.event.workflow_run.event }}",
                "actor": {
                  "login": "${{ github.event.workflow_run.actor.login }}"
                }
              },
              "repository": {
                "full_name": "${{ github.repository }}"
              }
            }'
      
      - name: Log notification sent
        run: |
          echo "CI failure notification sent to CI Notifier dashboard"
          echo "Check your dashboard at http://localhost:5173/dashboard"
